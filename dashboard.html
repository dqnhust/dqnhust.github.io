<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1080, initial-scale=1.0">
    <title>Document</title>
    <style>
        .totalTable tr:nth-child(even) {
            background-color: #dddddd;
        }

        .totalTable {
            display: block;
            empty-cells: show;
            border-spacing: 0;
            border: 1px solid;
        }

        .totalTable thead {
            background-color: #f1f1f1;
            position: relative;
            display: block;
            width: 100%;
            overflow-y: scroll;
        }

        .totalTable tfoot {
            background-color: #92e6ff;
            position: relative;
            display: block;
            width: 100%;
            overflow-y: scroll;
        }

        .totalTable tbody {
            display: block;
            position: relative;
            width: 100%;
            overflow-y: scroll;
            max-height: 500px;
            border-top: 1px solid rgba(0, 0, 0, 0.2);
        }

        .totalTable tr {
            width: 100%;
            display: flex;
        }

        .totalTable table {
            font-family: arial, sans-serif;
            width: 100%;
            display: table;
            box-sizing: border-box;
            text-indent: initial;
            border: 1px solid gray;
            border-collapse: collapse;
            text-align: center;
            vertical-align: middle;
        }

        .totalTable td,
        .totalTable th {
            text-align: center;
            padding: 8px;
            border: 1px solid gray;
            border-collapse: collapse;
            overflow: hidden;
        }

        .totalTable td,
        .totalTable th {
            flex-basis: 100%;
            flex-grow: 2;
            display: block;
            text-align: center;
            padding: 8px;
            border: 1px solid gray;
            border-collapse: collapse;
        }
    </style>
</head>

<body>
    <!-- Other -->
    <script>
        function SetLastXDay() {
            let xDay = document.getElementById("lastxDay").value;
            let today = new Date();
            let endDate = new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000);
            let beginDate = new Date(endDate.getTime() - (xDay - 1) * 24 * 60 * 60 * 1000);
            SetStartDate(beginDate);
            SetEndDate(endDate);
        }
        function GetStartDateString() {
            return document.getElementById("beginDate").value;
        }
        function GetEndDateString() {
            return document.getElementById("endDate").value;
        }
        function Get120DaysBeforeEndDateString() {
            return new Date(new Date(GetEndDateString()).getTime() - 120 * 24 * 60 * 60 * 1000).toISOString().substring(0, 10);
        }
        function SetStartDate(date) {
            document.getElementById("beginDate").value = date.toISOString().substring(0, 10);
        }
        function SetEndDate(date) {
            document.getElementById("endDate").value = date.toISOString().substring(0, 10);
        }
        function GetDays() {
            return Math.round
                ((new Date(GetEndDateString()).getTime() - new Date(GetStartDateString()).getTime()) / (1000 * 3600 * 24)) + 1;
        }
        function UpdateClientId() {
            let target = document.getElementById("clientId");
            clientId = target.value;
        }
        function UpdateAPIKey() {
            let target = document.getElementById("apiKey");
            apiKey = target.value;
        }
    </script>

    <!-- Extension Functions -->
    <script>
        function TryParseToNumber(s) {
            return parseFloat(s.replace(/(?!^-)[^0-9]/g, ""));
        }
        function ToCurrencyFormat(number) {
            return FormatNumberWithCommas(Round(number));
        }
        function ToPercentFormat(number) {
            return Math.round(number * 100) + "%";
        }
        function FormatNumberWithCommas(x) {
            return x.toString().replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",");
        }
        function Round(number) {
            let numDigits = (Math.round(number)).toString().length;
            let decimalPlaces = Math.max(5 - numDigits, 0);
            let factor = Math.pow(10, decimalPlaces);
            return Math.round(number * factor) / factor;
        }
    </script>
    <!-- Function GetData -->
    <script>
        var apiKey = "";
        var clientId = "";
        var authResponse = "";
        function IsLoggedIn() {
            return authResponse != "";
        }
        function HideElement(elementId) {
            let target = document.getElementById(elementId);
            target.style = "display: none";
        }
        function ShowLoggedInView() {
            ClearStyle("logedInView");
        }
        function ClearStyle(eId) {
            let target = document.getElementById(eId);
            target.style = "";
        }
        async function GetListAccount() {
            // 
            try {
                // let response = await fetch("https://analyticsadmin.googleapis.com/v1alpha/properties", {
                let response = await fetch("https://analyticsadmin.googleapis.com/v1alpha/accounts", {
                    method: "GET",
                    headers: postHeader,
                });
                if (response.ok) {
                    let json = await response.json();
                    return json.accounts;
                } else {
                    console.error("List Failed:", response.status);
                }
            } catch (err) {
                console.error("Request List Properties Failed:", err);
            }
            return null;
        }
        async function GetProperties(accountId) {
            try {
                //?filter=parent:accounts/316203369&key=AIzaSyBeo4NGA__U6Xxy-aBE6yFm19pgq8TY-TM
                let url = `https://analyticsadmin.googleapis.com/v1alpha/properties?filter=parent:${accountId}&key=${apiKey}`;
                console.log("Get Properties:", accountId);
                console.log("Start Get:" + url);
                let response = await fetch(url, {
                    method: "GET",
                    headers: postHeader,
                });
                console.log("Response:", response);
                if (response.ok) {
                    let json = await response.json();
                    // console.log(json);
                    return json.properties;
                } else {
                    console.error("List Failed:", response.status);
                }
            } catch (err) {
                console.error("Request List Properties Failed:", err);
            }
            return null;
        }
        async function ViewListAccounts() {
            SetLoading("Loading Accounts!");
            let accounts = await GetListAccount();
            let view = document.getElementById("accounts");
            let innerHTML = "";
            for (let account of accounts) {
                innerHTML += `<option value="${account.name}">${account.displayName}</option>`;
            }
            view.innerHTML = innerHTML;
            console.log(accounts);
            SetLoading("");
            ClearStyle("loadedAccountsView");
        }
        async function LoadCurrentData() {
            let element = document.getElementById("accounts");
            let accountId = element.value;
            let accountName = element.options[element.selectedIndex].text;
            SetLoading(`Loading Account ${accountName}`)
            let props = await GetProperties(accountId);
            let results = [];
            let i = 0;
            for (let prop of props) {
                SetLoading(`Loading Properties: ${i}/${props.length}`)
                console.log(prop);
                let gameData = await GetDataOfProject(prop.name, accountName);
                console.log("Content:", gameData);
                results.push(gameData);
                i++;
            }
            SetLoading("");
            let listGameData = ProcessData(results);
            ShowDataOnTable(listGameData);
        }
        // async function GetDataOfAllAccounts() {
        //     let result = [];
        //     let accounts = await GetListAccount();
        //     let totalProps = [];
        //     let i = 0;
        //     for (let account of accounts) {
        //         console.log(account);
        //         let props = await GetProperties(account.name);
        //         SetLoading(`Loading Account: ${i}/${accounts.length}`)
        //         for (let prop of props) {
        //             totalProps.push(prop)
        //         }
        //         i++;
        //     }
        //     i = 0;
        //     for (let prop of totalProps) {
        //         SetLoading(`Loading Properties: ${i}/${totalProps.length}`)
        //         console.log(prop);
        //         let gameData = await GetDataOfProject(prop.name, prop.displayName);
        //         console.log("Content:", gameData);
        //         result.push(gameData);
        //         i++;
        //     }
        //     SetLoading("");
        //     return result;
        // }
        function SetLoading(message) {
            let target = document.getElementById("loadingView");
            target.innerText = message;
        }
        // async function ShowData() {
        //     let data = await GetDataOfAllAccounts();
        //     let processedData = ProcessData(data);
        //     ShowDataOnTable(processedData);
        //     console.log("Data:", data);
        // }
        // class RowData {
        //     constructor(dimensions, metrics) {
        //         this.dimensions = dimensions;
        //         this.metrics = metrics;
        //     }
        //     GetKey() {
        //         return GetKey(this.dimensions);
        //     }
        //     AddData(metrics) {
        //         let n = Math.min(metrics.length, this.metrics.length);
        //         for (let i = 0; i < n; i++) {
        //             this.metrics[i] += metrics[i];
        //         }
        //     }
        //     GetRowViewData() {
        //         let result = [];
        //         for (let dimension of this.dimensions) {
        //             result.push(dimension);
        //         }
        //         for (let metric of this.metrics) {
        //             result.push(ToCurrencyFormat(metric));
        //         }
        //         return result;
        //     }
        //     IsFullData() {
        //         for (let metric of this.metrics) {
        //             if (metric <= 0) {
        //                 return false;
        //             }
        //         }
        //         return true;
        //     }
        //     static GetKey(dimensions) {
        //         return dimensions.join("-");
        //     }
        // }
        class GameResultData {
            constructor(propertyId, gameName, day) {
                this.gameName = gameName;
                this.propertyId = propertyId;
                this.headers = [];
                this.day = day;
                this.rows = {};
            }
            GetPropertyId() {
                return this.propertyId;
            }
            GetName() {
                return this.gameName;
            }
            SetHeaders(headers) {
                this.headers = headers;
            }
            GetHeaders() {
                return this.headers;
            }
            GetRowsViewData() {
                let result = [];
                for (let rowKey in this.rows) {
                    let row = this.rows[rowKey];
                    if (!row.IsFullData()) {
                        continue;
                    }
                    result.push(row.GetRowViewData());
                }
                return result;
            }
            AddRowData(rawRowData) {
                let key = rawRowData.GetKey();
                if (!this.rows.hasOwnProperty(key)) {
                    this.rows[key] = RawRowData.FromTemplate(rawRowData);
                } else {
                    this.rows[key].AddData(rawRowData);
                }
            }
        }
        function ProcessData(listGameData) {
            let result = [];
            for (let gameData of listGameData) {
                let item = new GameResultData(gameData.propertyId, gameData.name, gameData.day);
                item.SetHeaders(gameData.rawTableData.headers);
                if (!gameData.rawTableData.IsValidData())
                    continue;
                for (let rawRow of gameData.rawTableData.rows) {
                    item.AddRowData(rawRow);
                }
                result.push(item);
            }
            return result;
        }

        function ShowDataOnTable(listGameData) {
            let htmlCode = "";
            for (let gameData of listGameData) {
                htmlCode += GetTableHtmlCode(gameData);
            }
            let table = document.getElementById("tableView");
            table.innerHTML = htmlCode;
            AssignEvents();
        }
        function AssignEvents() {
            let inputs = document.querySelectorAll("input#targetProfitPerDay");
            for (let input of inputs) {
                input.addEventListener("change", function () {
                    UpdateBudgetValue(input);
                }, false);
                input.addEventListener("keyup", function () {
                    UpdateBudgetValue(input);
                }, false);
                UpdateBudgetValue(input);
            }


            inputs = document.querySelectorAll("input#findRoas");
            for (let input of inputs) {
                input.addEventListener("click", function () {
                    FindRoas(input);
                }, false);
            }
        }

        async function FindRoas(input) {
            let trElement = input.closest("tr");
            let campaignName = trElement.querySelector("div#campaignName").innerText;
            let targetDay = parseInt(document.getElementById("targetDay").value);
            let tableElement = input.closest("table");
            let propertyId = tableElement.getAttribute("propertyId");
            let resultView = trElement.querySelector("div#roasResult");
            resultView.innerText = "Loading!";
            let ltvData = await GetLTVData(propertyId, campaignName);
            resultView.innerText = `${ToCurrencyFormat(ltvData.GetLtv(targetDay))}/${ToCurrencyFormat(ltvData.GetMaxLtv())} = ${ToPercentFormat(ltvData.GetLtvPercent(targetDay))}`;
        }

        function UpdateBudgetValue(input) {
            if (isNaN(TryParseToNumber(input.value)))
                return;
            let tableElement = input.closest("table");
            let day = parseInt(tableElement.getAttribute("day"));
            let trElement = input.closest("tr");
            // let targetViewDiv = trElement.querySelector("div#targetProfitPerDayView");
            let targetBudgetPerDay = trElement.querySelector("div#targetBudgetPerDay");
            let admobRevPerDay = parseFloat(trElement.querySelector("div#admobRevenuePerDay").innerText.replaceAll(",", ""));
            targetBudgetPerDay.innerText = ToCurrencyFormat(Math.max(admobRevPerDay - TryParseToNumber(input.value), 0));
            // targetViewDiv.innerText = ToCurrencyFormat(input.value);
            input.value = ToCurrencyFormat(TryParseToNumber(input.value));
        }
        function GetTableHtmlCode(gameData) {
            let code = `<h1>${gameData.GetName()}</h1><br/>`;
            code += `<table class="totalTable" day="${gameData.day}" propertyId="${gameData.propertyId}">`;
            let headers = gameData.GetHeaders()
            let rows = gameData.GetRowsViewData();
            code += `<tr>`;
            for (let header of headers) {
                code += `<th>`;
                code += header;
                code += `</th>`;
            }
            code += `</tr>`;
            code += `<tbody>`;
            for (let row of rows) {
                code += `<tr>`;
                for (let column of row) {
                    code += `<td>`;
                    code += column;
                    code += `</td>`;
                }
                code += `</tr>`;
            }
            code += `</tbody>`;
            code += `</table>`;
            return code;
        }

        // function GetHeaders(rawData) {
        //     let result = [];
        //     for (let item of rawData.dimensionHeaders) {
        //         result.push(item.name);
        //     }
        //     for (let item of rawData.metricHeaders) {
        //         result.push(item.name);
        //     }
        //     return result;
        // }
        class RawRowData {
            constructor(campaignName, adCost, admobRevenue, day) {
                this.campaignName = campaignName;
                this.adCost = adCost;
                this.admobRevenue = admobRevenue;
                this.day = day;
            }
            GetCampaignName() {
                return this.campaignName;
            }
            GetAdCost() {
                return this.adCost;
            }
            GetAdmobRevenue() {
                return this.admobRevenue;
            }
            GetKey() {
                return this.campaignName;
            }
            AddData(data) {
                this.adCost += data.adCost;
                this.admobRevenue += data.admobRevenue;
            }
            IsFullData() {
                return this.admobRevenue > 0;
            }

            GetRowViewData() {
                return [
                    `<input type="text" id="targetProfitPerDay" style="text-align: center" value="0"">`,
                    `<div id="campaignName">${this.campaignName}</div>`,
                    `<div id="adCostPerDay">${ToCurrencyFormat(this.adCost / this.day)}</div>`,
                    `<div id="admobRevenuePerDay">${ToCurrencyFormat(this.admobRevenue / this.day)}</div>`,
                    `${ToCurrencyFormat((this.admobRevenue - this.adCost) / this.day)}`,
                    `<div id="targetBudgetPerDay">0</div>`,
                    `<input type="button" value="Find Roas" id="findRoas"/><br/><div id="roasResult"></div>`
                ];
            }
            static FromJson(json, day) {
                return new RawRowData(
                    json["dimensionValues"][0].value,
                    json["metricValues"][0].value,
                    json["metricValues"][1].value,
                    day);
            }
            static FromTemplate(data) {
                return new RawRowData(data.campaignName, data.adCost, data.admobRevenue, data.day);
            }
        }
        class RawTableData {
            constructor(json, day) {
                this.headers = ["Lãi/Ngày Mong Muốn", "Chiến Dịch", "Chi Phí/Ngày", "Doanh Thu/Ngày", "Lãi/Ngày Hiện Tại", "Daily Budget Phù Hợp", `Tìm Roas<br/><input type="number" id="targetDay" min=1 value=7 style="textalign: center"/>`];
                this.rows = this.#GetRawRowData(json, day);
            }

            #GetRawRowData(json, day) {
                let result = [];
                if (!json.hasOwnProperty("rows"))
                    return null;
                for (let row of json.rows) {
                    result.push(RawRowData.FromJson(row, day));
                }
                return result;
            }
            IsValidData() {
                return this.rows != null;
            }
        }
        class LTVData {
            constructor() {
                this.ltv = 0;
                this.ltvByDay = {};
                this.arpuByDay = {};
            }
            static FromJson(json) {
                let result = new LTVData();
                for (let item of json.rows) {
                    let day = parseInt(item.dimensionValues[1].value);
                    let arpu = parseFloat(item.metricValues[0].value);
                    result.arpuByDay[day] = arpu;
                }
                let currentLtv = 0;
                for (let day = 0; day <= 120; day++) {
                    let arpu = 0;
                    if (result.arpuByDay.hasOwnProperty(day)) {
                        arpu = result.arpuByDay[day];
                    }
                    currentLtv += arpu;
                    result.ltvByDay[day] = currentLtv;
                }
                result.ltv = currentLtv;
                console.log(result);
                return result;
            }
            GetLtv(day) {
                if (this.ltvByDay.hasOwnProperty(day)) {
                    return this.ltvByDay[day];
                }
                return this.GetMaxLtv();
            }
            GetLtvPercent(day) {
                return this.GetLtv(day) / this.GetMaxLtv();
            }
            GetMaxLtv() {
                return this.ltv;
            }
        }
        async function GetDataOfProject(propertyId, displayName) {
            try {

                let url = `https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport?key=${apiKey}`;
                console.log("Start Get Content At:", url);
                let fetchRequest = await fetch(url, {
                    method: "POST",
                    headers: postHeader,
                    body: JSON.stringify(GetPostBody()),
                });
                let content = await fetchRequest.json();
                console.log(`${propertyId}|${displayName}=>`, content);
                return {
                    propertyId: propertyId,
                    name: `${displayName} in ${GetDays()} days [${GetStartDateString()} to ${GetEndDateString()}]`,
                    day: GetDays(),
                    rawTableData: new RawTableData(content, GetDays())
                };
            } catch (err) {
                console.error(err);
                return null;
            }
        }
        async function GetLTVData(propertyId, campaignName) {
            try {

                let url = `https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport?key=${apiKey}`;
                console.log("Start Get Content At:", url);
                let fetchRequest = await fetch(url, {
                    method: "POST",
                    headers: postHeader,
                    body: JSON.stringify({
                        "dimensions": [
                            {
                                "name": "cohort"
                            },
                            {
                                "name": "cohortNthDay"
                            }
                        ],
                        "metrics": [
                            {
                                "name": "ARPU",
                                "expression": "(totalRevenue) / (cohortTotalUsers)"
                            }
                        ],
                        "cohortSpec": {
                            "cohorts": [
                                {
                                    "dimension": "firstSessionDate",
                                    "dateRange": {
                                        "startDate": Get120DaysBeforeEndDateString(),
                                        "endDate": GetEndDateString()
                                    },
                                    "name": campaignName
                                }
                            ],
                            "cohortsRange": {
                                "endOffset": 120,
                                "granularity": "DAILY"
                            }
                        },
                        "dimensionFilter": {
                            "filter": {
                                "fieldName": "firstUserCampaignName",
                                "inListFilter": {
                                    "values": [
                                        campaignName
                                    ]
                                }
                            }
                        }
                    }),
                });
                let content = await fetchRequest.json();
                console.log("ARPU Response:", content);
                return LTVData.FromJson(content);
            } catch (err) {
                console.error(err);
                return null;
            }
        }

        var postHeader = "";
        function GetPostBody() {
            return {
                "dateRanges": [
                    {
                        "startDate": GetStartDateString(),
                        "endDate": GetEndDateString()
                    }
                ],
                "dimensions": [
                    {
                        "name": "firstUserCampaignName",
                    },
                ],
                "metrics": [
                    {
                        "name": "advertiserAdCost",
                    },
                    {
                        "name": "totalRevenue",
                    },
                ],
                "currencyCode": "VND"
            };
        }
        function HandleCredentialResponse(response) {
            authResponse = response;
            console.log("Authorize Response:", authResponse);
            postHeader = {
                "Content-type": "application/json; charset=UTF-8",
                "Authorization": `Bearer ${authResponse.access_token}`,
                "Accept": "application/json",
                "Content-Type": "application/json"
            };
            // SetLoading("Logged In!");
            HideElement("beforeLogin");
            ShowLoggedInView();
            ViewListAccounts();
        }
    </script>

    <!-- Login To Get Token -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        var tokenClient;
        async function InitTokenClient() {
            tokenClient = await google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/analytics.readonly',
                prompt: '',
                callback: HandleCredentialResponse,
            });
        }
        async function RequestToken() {
            await InitTokenClient();
            tokenClient.requestAccessToken();
        }
    </script>
    <!-- View -->
    <div id="beforeLogin">
        <input type="text" name="apiKey" id="apiKey" value="" placeholder="Nhập API Key" onkeyup="UpdateAPIKey()"
            onchange="UpdateAPIKey()" />
        <input type="text" name="clientId" id="clientId" value="" placeholder="Nhập ClientId" onkeyup="UpdateClientId()"
            onchange="UpdateClientId()" />
        <button onclick="RequestToken()" id="btnLogin">Login</button>
    </div>
    <div id="logedInView" style="display: none;">
        <div id="loadedAccountsView" style="display: none;">
            <label for="accounts">Accounts:</label>
            <select name="accounts" id="accounts">
            </select>
            <label for="beginDate">Begin Date:</label>
            <input type="date" id="beginDate" value="2000-01-01">
            <label for="endDate">End Date:</label>
            <input type="date" id="endDate" value="3000-01-01">
            <label for="endDate">Set Last X Days:</label>
            <input type="number" id="lastxDay" value="30" min="7">
            <input type="button" value="Set Date" onclick="SetLastXDay()" />
            <input type="button" value="Load Data" onclick="LoadCurrentData()">
            <div id="tableView">
            </div>
        </div>
    </div>
    <div id="loadingView"></div>
    <script>
        SetLastXDay();
    </script>
</body>

</html>